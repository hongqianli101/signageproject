<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Interactive HTML Bars with D3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div><h2>CITY OF SIGNS</h2></div>
    <div id="barcontainer"></div>
    <script type="text/javascript">

    let baseWidth = 10; 
    let baseGap = 4; 
    let width = baseWidth; 
    let gap = baseGap;
    let selectedId = null;
    let data = []; 

    d3.json("data.json").then(function(loadedData) {
        data = loadedData;
        const expandedWidth = width * 24; 
        const bars = d3.select("#barcontainer").selectAll(".bar")
        .data(data)
        .enter().append("div")
        .attr("class", "bar")
        .attr("data-id", d => d.id) 
        .style("left", (d, i) => `${i * (width + gap)}px`)
        .style("top", "24px")
        .style("height", "1000px");
            bars.each(function(d) {
            const selection = d3.select(this);
                selection.append("img").attr("src", d.e_image_s);
                const firstTextContainer = selection.append("div").attr("class", "text-container");
                firstTextContainer.append("p").text(d.e_text);
                selection.append("div").attr("class", "titletext").append("p").text('Category');  
                selection.append("img").attr("src", d.e_image_c).style("height", "30px").style("width", "300px").style("margin-left", "-30px");
                selection.append("div").attr("class", "titletext").append("p").text('Language');  
                selection.append("img").attr("src", d.e_image_l).style("height", "30px").style("width", "300px").style("margin-left", "-30px");
                selection.append("div").attr("class", "titletext").append("p").text('Meidan household income');  
                selection.append("img").attr("src", d.image_h).style("height", "30px").style("width", "330px").style("margin-left", "-40px");
                selection.append("div").attr("class", "titletext").append("p").text('Race');  
                selection.append("img").attr("src", d.image_d).style("height", "30px").style("width", "330px").style("margin-left", "-40px");
                selection.append("div").attr("class", "titletext").append("p").text('Language'); 
                selection.append("img").attr("src", d.w_image_l).style("height", "30px").style("width", "300px").style("margin-left", "-30px");
                selection.append("div").attr("class", "titletext").append("p").text('Category');  
                selection.append("img").attr("src", d.w_image_c).style("height", "30px").style("width", "300px").style("margin-left", "-30px");
                const secondTextContainer = selection.append("div").attr("class", "text-container");
                secondTextContainer.append("p").text(d.w_text);
                selection.append("img").attr("src", d.w_image_s);
                });





////// Function to update which bar is selected and expanded
                let selectedId = data[0].id; 
                function selectBar(newId) {
                    selectedId = newId;
    
                bars.classed("expanded", false)
                    .transition()
                    .style("width", width + "px")
                    .select("p").style("display", "none");
    
                bars.filter(d => d.id === selectedId)
                    .classed("expanded", true)
                    .transition()
                    .style("width", expandedWidth + "px")
                    .select("p").style("display", "block");
    
                // Adjust left position of each bar based on the new selection
                bars.style("left", (d, i) => {
                    const index = data.findIndex(bar => bar.id === selectedId);
                    if (i < index) {
                        return `${i * (width + gap)}px`;
                    } else if (i === index) {
                        return `${i * (width + gap)}px`;
                    } else {
                        return `${i * (width + gap) + (expandedWidth - width)}px`;
                    }
                });
            
            updateCommunityOverlays(); // 更新社区覆盖层的位置和宽度
            }
            // Initially select the first bar
            selectBar(selectedId);
            // Bar click event
            bars.on("click", function(_, d) {
                selectBar(d.id);
            });
            // Keyboard navigation
            d3.select(window).on("keydown", function(event) {
                const index = data.findIndex(bar => bar.id === selectedId);
                if (event.key === "ArrowRight" && index < data.length - 1) {
                    selectBar(data[index + 1].id);
                } else if (event.key === "ArrowLeft" && index > 0) {
                    selectBar(data[index - 1].id);
                }
            });
});






///////////////// 在窗口上监听鼠标滚轮事件
let currentScale = 1;
window.addEventListener('wheel', function(event) {
    if(event.deltaY < 0) {
        currentScale *= 1.1; // 向上滚动，放大
    } else {
        currentScale /= 1.1; // 向下滚动，缩小
    }

    // 限制缩放级别
    currentScale = Math.max(Math.min(currentScale, 1), 0.05);

    // 更新 bars 的宽度和间隙
    updateBarsPositionAndSize();
}, { passive: false });

function updateBarsPositionAndSize() {
    const newWidth = baseWidth * currentScale; // 计算新宽度
    const newGap = baseGap * currentScale; // 计算新间隙

    d3.select("#barcontainer").selectAll(".bar")
        .style("width", newWidth + "px")
        .style("left", function(d, i) {
            return `${i * (newWidth + newGap)}px`;
        });
}

function updateBarsPositionAndSize() {
    const newWidth = baseWidth * currentScale; // 计算新宽度
    const newGap = baseGap * currentScale; // 计算新间隙

    d3.select("#barcontainer").selectAll(".bar")
        .style("width", newWidth + "px")
        .style("left", function(d, i) {
            return `${i * (newWidth + newGap)}px`;
        });

    updateCommunityOverlays(); // 更新社区方块的位置和宽度
}




////// 根据 community 对 bars 进行分组
const communities = d3.group(data, d => d.community);

communities.forEach((bars, communityName) => {
const firstBar = bars[0];
const lastBar = bars[bars.length - 1];

// 计算 community 覆盖层的位置和宽度
const communityPosition = parseFloat(d3.select(`.bar[data-id="${firstBar.id}"]`).style("left"));
const lastBarPosition = parseFloat(d3.select(`.bar[data-id="${lastBar.id}"]`).style("left"));
const communityWidth = (lastBarPosition - communityPosition) + (width * currentScale);

// 在 barcontainer 中为这个 community 创建一个长方形覆盖层
d3.select("#barcontainer").append("div")
    .attr("class", "community")
    .style("left", `${communityPosition}px`)
    .style("width", `${communityWidth}px`)
    .style("top", "0px") 
    .style("height", "20px") 
    .text(communityName) 
    .on("click", function() {
        window.scrollTo({
            top: document.querySelector(`.bar[data-id="${firstBar.id}"]`).offsetTop,
            behavior: 'smooth'
        });
    });
    });


function updateCommunityOverlays() {
    // 从全局变量获取 data
    const communities = d3.group(data, d => d.community);
    communities.forEach((bars, communityName) => {
        const firstBar = bars[0];
        const lastBar = bars[bars.length - 1];
        
        // 确保这里使用了更新后的 bar 位置和宽度
        const firstBarDiv = d3.select(`.bar[data-id="${firstBar.id}"]`);
        const lastBarDiv = d3.select(`.bar[data-id="${lastBar.id}"]`);

        // 使用 parseFloat 确保从样式中获取的值被正确解析为数字
        const firstBarLeft = parseFloat(firstBarDiv.style("left"));
        const lastBarRight = parseFloat(lastBarDiv.style("left")) + parseFloat(lastBarDiv.style("width"));

        const communityWidth = lastBarRight - firstBarLeft;

        // 查找或创建社区方块
        let communityDiv = d3.select(`.community[data-community="${communityName}"]`);
        if (communityDiv.empty()) {
            communityDiv = d3.select("#barcontainer").append("div")
                .attr("class", "community")
                .attr("data-community", communityName);
        }

        communityDiv.style("left", `${firstBarLeft}px`)
            .style("width", `${communityWidth}px`)
            .text(communityName); 
    });
}




    </script>
</body>
</html>